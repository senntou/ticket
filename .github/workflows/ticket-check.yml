name: Ticket Availability Check

on:
  schedule:
    # 15åˆ†é–“éš”ã§å®Ÿè¡Œ (GitHub Actionsã®æœ€å°é–“éš”ã¯5åˆ†)
    - cron: "*/15 * * * *"
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  TICKET_URL: ${{ secrets.TICKET_URL }}
  TARGET_CLASS: ${{ secrets.TARGET_CLASS }}
  LINE_ACCESS_TOKEN: ${{ secrets.LINE_ACCESS_TOKEN }}

jobs:
  check-ticket:
    runs-on: ubuntu-latest
    environment: production # Environment secrets ã‚’ä½¿ç”¨

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          playwright install chromium
          playwright install-deps

      - name: Run ticket check
        id: ticket_check
        run: |
          python check_once.py
        env:
          TICKET_URL: ${{ secrets.TICKET_URL }}
          TARGET_CLASS: ${{ secrets.TARGET_CLASS }}
          LINE_ACCESS_TOKEN: ${{ secrets.LINE_ACCESS_TOKEN }}
        continue-on-error: true

      - name: Check result and notify
        run: |
          exit_code=${{ steps.ticket_check.outcome }}
          echo "ãƒã‚±ãƒƒãƒˆãƒã‚§ãƒƒã‚¯çµæœ: $exit_code"

          if [ "$exit_code" == "success" ]; then
            echo "âœ… ãƒã‚±ãƒƒãƒˆã¯å®Œå£²ä¸­ã§ã™"
          else
            echo "ğŸš¨ ãƒã‚±ãƒƒãƒˆãŒè²©å£²ä¸­ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼"
          fi
